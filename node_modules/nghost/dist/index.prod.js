"use strict";var app=require("express")(),favicon=require("serve-favicon"),fs=require("fs"),path=require("path"),url=require("url"),session=require("express-session"),stringReplaceStream=require("string-replace-stream"),bodyParser=require("body-parser"),options={publicFolder:path.join(__dirname,"public"),hostname:"localhost",favicon:path.join(__dirname,"favicon.ico"),port:80,bodyParser:!0,encode:"utf-8",session:"",contents:[{key:/\.html$/,type:"text",contentType:"text/html"},{key:/\.js$/,type:"text",contentType:"application/javascript"},{key:/\.css$/,type:"text",contentType:"text/css"},{key:/\.json$/,type:"text",contentType:"application/json"},{key:/\.svg$/,type:"binary",contentType:"image/svg+xml"},{key:/\.woff$/,type:"binary",contentType:"application/font-woff woff"},{key:/\.woff2$/,type:"binary",contentType:"application/font-woff2"},{key:/\.eot$/,type:"binary",contentType:"application/vnd.ms-fontobject eot"},{key:/\.ttf$/,type:"binary",contentType:"application/x-font-ttf"},{key:/\.mp4$/,type:"binary",contentType:"video/mp4"},{key:/\.flv$/,type:"binary",contentType:"video/x-flv"},{key:/\.map$/,type:"binary",contentType:"application/octet-stream"},{key:/\.jpg$/,type:"binary",contentType:"image/jpg"},{key:/\.png$/,type:"binary",contentType:"image/png"},{key:/\.jpeg$/,type:"binary",contentType:"image/jpeg"}],gets:[],posts:[],"Access-Control-Allow-Origin":"*","Access-Control-Allow-Headers":"Origin, X-Requested-With, Content-Type, Accept"},nghost=function(e){var t=0<arguments.length&&void 0!==e?e:options;if(options=addIfNotExist(options,t),!fs.existsSync(options.publicFolder))throw"Public folder not found.";return fs.existsSync(options.favicon)&&app.use(favicon(options.favicon)),t.session&&app.use(session({secret:t.session,resave:!0,saveUninitialized:!0})),app.use(function(e,t,n){t.header("Access-Control-Allow-Origin",options["Access-Control-Allow-Origin"]),t.header("Access-Control-Allow-Headers",options["Access-Control-Allow-Headers"]),n()}),t.bodyParser&&(app.use(bodyParser.json()),app.use(bodyParser.urlencoded({extended:!0}))),app.get(/.*/,function(e,t){var n=!1;if(e.url.substring(0).search(/[^.]*$/)<=0)for(get in options.gets)try{if(e.url.match(options.gets[get].key)){n=!0,options.gets[get].function.call(options.gets[get],e,t);break}}catch(e){}n||getGenericRequest(e,t)}),app.post(/.*/,function(e,t){var n=!1;if(e.url.substring(0).search(/[^.]*$/)<=0)for(get in options.posts)try{if(e.url.match(options.posts[get].key)){n=!0,options.posts[get].function.call(options.posts[get],e,t);break}}catch(e){e&&console.log("Error :",e)}n||getGenericRequest(e,t)}),app.listen(options.port),app};function getGenericRequest(e,t){var n=url.parse(e.url).pathname.split("/").filter(function(e){return 0<e.length});0==n.length?(t.setHeader("Content-Type","text/html"),t.write(fs.readFileSync(path.join(options.publicFolder,"index.html"),"utf-8")),t.end()):checkReqAndSend(n.join("/"),t)}function checkReqAndSend(t,n){var e=!1;for(ctn in options.contents)if(t.match(options.contents[ctn].key)){e=!0,"text"==options.contents[ctn].type?responseText(n,t,options.contents[ctn].contentType):responseBinary(n,t,options.contents[ctn].contentType);break}if(!e)if(t.match(/^\/[a-zA-Z]{1}[a-zA-Z0-9]{2,8}$/)){var o=path.join(options.publicFolder,t)+".html";fs.access(o,function(e){e?response(n,"404",'<h1 style="color:green; font-size:5em; font-weight:100;">\n                        Ok Successful route But We Don\'t find the file...\n                    </h1>'):responseText(n,"".concat(t,".html"),"text/html")})}else response(n,"404",'<h1 style="color:red; font-size:5em; font-weight:100;">Error Request</h1>')}function responseText(e,t,n){response(e,t,n,options.encode)}function responseBinary(e,t,n){response(e,t,n)}var response=function(e,t,n,o){if("404"!=t){if(e.writeHead(200,{"Content-type":n}),o)var s=fs.createReadStream(path.join(options.publicFolder,t),o).pipe(stringReplaceStream("localhost:"+options.port,options.hostname+":"+options.port));else s=fs.createReadStream(path.join(options.publicFolder,t)).pipe(stringReplaceStream("localhost:"+options.port,options.hostname+":"+options.port));s.pipe(e)}else e.writeHead(404,{"Content-type":"text/html"}),e.end("\n            ".concat(n,"\n        "))},addIfNotExist=function(t,e){if(e.contents)for(ctn in t.contents)0==e.contents.filter(function(e){return String(e.key)===String(t.contents[ctn].key)}).length&&e.contents.push(t.contents[ctn]);if(e.gets)for(ctn in t.gets)0==e.gets.filter(function(e){return String(e.key)===String(t.gets[ctn].key)}).length&&e.gets.push(t.gets[ctn]);if(e.posts)for(ctn in t.posts)0==e.posts.filter(function(e){return String(e.key)===String(t.posts[ctn].key)}).length&&e.posts.push(t.posts[ctn]);if(e.sessionKey)for(ctn in t.sessionKey)0==e.sessionKey.filter(function(e){return String(e.key)===String(t.sessionKey[ctn].key)}).length&&e.sessionKey.push(t.sessionKey[ctn]);for(element in t)e[element]&&(t[element]=e[element]);return t};module.exports=nghost;